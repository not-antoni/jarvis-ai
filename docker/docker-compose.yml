# Jarvis AI - Full Stack Docker Compose
#
# Usage:
#   docker-compose -f docker/docker-compose.yml up -d
#   docker-compose -f docker/docker-compose.yml logs -f jarvis
#   docker-compose -f docker/docker-compose.yml down
#
# First time setup:
#   1. Copy .env.example to .env and configure
#   2. Run: docker-compose -f docker/docker-compose.yml up -d

version: "3.8"

services:
  # ===========================================
  # Jarvis Discord Bot
  # ===========================================
  jarvis:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: jarvis-bot
    restart: unless-stopped
    env_file: ../.env
    environment:
      - NODE_ENV=production
      - DEPLOY_TARGET=selfhost
      - SELFHOST_MODE=true
      - MONGO_URI_MAIN=mongodb://mongodb:27017/jarvis_ai
      - MONGO_URI_VAULT=mongodb://mongodb:27017/jarvis_vault
      - LAVALINK_HOST=lavalink:2333
      - LAVALINK_PASSWORD=${LAVALINK_PASSWORD:-youshallnotpass}
    ports:
      - "3000:3000"
    volumes:
      - jarvis_data:/app/data
      - jarvis_logs:/app/logs
    depends_on:
      mongodb:
        condition: service_healthy
      lavalink:
        condition: service_started
    networks:
      - jarvis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================
  # MongoDB Database
  # ===========================================
  mongodb:
    image: mongo:7
    container_name: jarvis-mongodb
    restart: unless-stopped
    environment:
      - MONGO_INITDB_DATABASE=jarvis_ai
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    ports:
      - "27017:27017"
    networks:
      - jarvis-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command: ["mongod", "--bind_ip_all"]

  # ===========================================
  # YouTube Cipher Server (for Lavalink)
  # ===========================================
  yt-cipher:
    image: ghcr.io/kikkia/yt-cipher:master
    container_name: jarvis-yt-cipher
    restart: unless-stopped
    environment:
      - API_TOKEN=${YT_CIPHER_TOKEN:-yt-cipher-token-12345}
    ports:
      - "8001:8001"
    networks:
      - jarvis-network

  # ===========================================
  # Lavalink Music Server
  # ===========================================
  lavalink:
    image: ghcr.io/lavalink-devs/lavalink:4
    container_name: jarvis-lavalink
    restart: unless-stopped
    environment:
      - _JAVA_OPTIONS=-Xmx512M
      - SERVER_PORT=2333
      - LAVALINK_SERVER_PASSWORD=${LAVALINK_PASSWORD:-youshallnotpass}
      # YouTube OAuth (optional, for better playback)
      - YOUTUBE_OAUTH_CLIENT_ID=${LAVALINK_YOUTUBE_CLIENT_ID:-}
      - YOUTUBE_OAUTH_CLIENT_SECRET=${LAVALINK_YOUTUBE_CLIENT_SECRET:-}
      - YOUTUBE_OAUTH_REFRESH_TOKEN=${LAVALINK_YOUTUBE_REFRESH_TOKEN:-}
      - YT_CIPHER_URL=http://yt-cipher:8001
      - YT_CIPHER_TOKEN=${YT_CIPHER_TOKEN:-yt-cipher-token-12345}
    volumes:
      - ./lavalink/application.yml:/opt/Lavalink/application.yml:ro
      - lavalink_plugins:/opt/Lavalink/plugins
      - lavalink_logs:/opt/Lavalink/logs
    ports:
      - "2333:2333"
    networks:
      - jarvis-network
    depends_on:
      - yt-cipher

# ===========================================
# Networks
# ===========================================
networks:
  jarvis-network:
    driver: bridge

# ===========================================
# Volumes
# ===========================================
volumes:
  jarvis_data:
    name: jarvis_data
  jarvis_logs:
    name: jarvis_logs
  mongodb_data:
    name: jarvis_mongodb_data
  mongodb_config:
    name: jarvis_mongodb_config
  lavalink_plugins:
    name: jarvis_lavalink_plugins
  lavalink_logs:
    name: jarvis_lavalink_logs
